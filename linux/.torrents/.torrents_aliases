# export TORRENT_URL="https://thepiratebay.party/search"
export TORRENT_DIRECTORY="/mnt/HOME/series"
export TORRENT_INFO_MODE=1

get_torrent_metadata() {
    torrent_url="$1"

    local page details file_size seeders leechers type info comments
    page="$(wget -qO- "$torrent_url")"
    details="$(echo "$page" | sed -n '/<div.*id="details">/,/<\/div>/p')"

    file_size=$(echo "$details" | grep -A1 '<dt>Size:</dt>' | tail -n1 | sed -E 's/<[^>]+>//g')
    seeders=$(echo "$details" | grep -A1 '<dt>Seeders:</dt>' | tail -n1 | sed -E 's/<[^>]+>//g')
    leechers=$(echo "$details" | grep -A1 '<dt>Leechers:</dt>' | tail -n1 | sed -E 's/<[^>]+>//g')
    type=$(echo "$details" | grep -A1 '<dt>Type:</dt>' | tail -n1 | sed -E 's/<[^>]+>//g')
    info=$(echo "$page" | sed -n '/<div.*class="nfo">/,/<\/div>/p' | sed -E 's/<[^>]+>//g')

    echo "=============================="
    echo " Torrent Metadata"
    echo "=============================="
    echo " Type     : $type"
    echo " Size     : $file_size"
    echo " Seeders  : $seeders"
    echo " Leechers : $leechers"
    echo "------------------------------"
    echo " Info:"
    echo "$info"
    echo "------------------------------"
    echo "URL:"
    echo "$torrent_url"
    echo "=============================="
}

download_torrent() {
    magnet="$1"

    if [ -z "$TORRENT_DIRECTORY" ]; then
        TORRENT_DIRECTORY="$HOME"
    fi
    transmission-cli "$magnet" -w "$TORRENT_DIRECTORY"
}

torrent() {
    TORRENT_URL="https://thepiratebay.party/search"

    [[ $1 ]] && q="$*" || read -p "Enter Search Query: " q
    echo "$TORRENT_URL/$q" | sed 's/ /%20/g'

    local page="$(wget -qO- "$TORRENT_URL/$q" | sed 's@+@ @g;s@%@\\x@g' | xargs -0 printf "%b")"

    local magnet_links=()
    local info_links=()

    info_links=("$(echo "$page" | grep '<a href="[^"]*"' | grep '/torrent/' | cut -d'"' -f2)")
    magnet_links=("$(echo "$page" | grep magnet | grep -v '<meta' | sed 's/href="magnet/\nmagnet/g' | grep magnet | cut -d\" -f1 | awk -F\& '{print $2 "|" $1}' | tr "+" " " | sed 's/dn=//g')")

    local state_file

    state_file=$(mktemp)

    if [ -z "$TORRENT_INFO_MODE" ]; then
        TORRENT_INFO_MODE=1
    fi

    echo $TORRENT_INFO_MODE >"$state_file"

    selection=$(
        printf '%s\n' "${magnet_links[@]}" |
            fzf \
                --preview-window=down,1,border-top \
                --preview '
                if [[ $(cat '"$state_file"') -eq 1 ]]; then
                    echo "INFO MODE for: {}"
                else
                    echo "DOWNLOAD_MODE for: {}"
                fi
            ' \
                --bind "ctrl-i:execute-silent(
                if [[ \$(cat $state_file) -eq 0 ]]; then
                    echo 1 > $state_file
                else
                    echo 0 > $state_file
                fi
            )+reload(if [[ \$(cat $state_file) -eq 1 ]]; then echo \"${info_links[@]}\"; else echo \"${magnet_links[@]}\"; fi)+refresh-preview"
    )

    local TORRENT_INFO_MODE
    TORRENT_INFO_MODE=$(cat "$state_file")
    rm -f "$state_file"

    [[ $selection ]] || return 1

    if [[ $TORRENT_INFO_MODE -eq 1 ]]; then
        get_torrent_metadata "$selection"
    else
        magnet="$(echo -e "$selection" | cut -d\| -f2)"
        download_torrent "$magnet"
    fi
}
