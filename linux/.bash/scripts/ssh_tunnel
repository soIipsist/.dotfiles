#!/usr/bin/bash

set -euo pipefail

if [ -z "$REMOTE_SERVER" ]; then
    REMOTE_SERVER="${REMOTE_USER}@${REMOTE_HOST}"

    if [ -z "$REMOTE_USER" ]; then
        echo "Remote user not found!"
    fi
    if [ -z "$REMOTE_HOST" ]; then
        echo "Remote host not found!"
    fi
fi

if [ -z "$REMOTE_PORT" ]; then
    REMOTE_PORT="2222"
fi

if [ -z "$TUNNEL_KEY" ]; then
    echo "Tunnel key not found!"
    exit 1
fi

echo "[$(date)] Starting persistent reverse tunnel â†’ ${REMOTE_SERVER}:${REMOTE_PORT}"

exec autossh -M 0 -N \
    -o "ServerAliveInterval=30" \
    -o "ServerAliveCountMax=3" \
    -o "ExitOnForwardFailure=yes" \
    -o "StrictHostKeyChecking=no" \
    -i "$TUNNEL_KEY" \
    -R "${REMOTE_PORT}:localhost:22" \
    "$REMOTE_SERVER"
