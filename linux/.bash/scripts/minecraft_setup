#!/bin/bash

if [ -z "$SERVER_PROPERTIES" ]; then
    SERVER_PROPERTIES="/home/steam/minecraft_server/server.properties"
fi

if [ -z "$RCON_PORT" ]; then
    RCON_PORT=25575
fi

# If the server.properties file doesn't exist, create it
if [ ! -f "$SERVER_PROPERTIES" ]; then
    echo "server.properties not found, creating a new one..."
    cat >"$SERVER_PROPERTIES" <<EOF
# Minecraft server properties
enable-rcon=true
rcon.port=$RCON_PORT
rcon.password=$RCON_PASSWORD
enable-query=false
EOF
    echo "Created new server.properties with RCON enabled."
    exit 0
fi

# Backup existing server.properties
cp "$SERVER_PROPERTIES" "$SERVER_PROPERTIES.bak.$(date +%Y%m%d%H%M%S)"

# Ensure RCON settings are set
echo "Ensuring RCON settings are configured..."

# enable-rcon
if grep -q "^enable-rcon=" "$SERVER_PROPERTIES"; then
    sed -i 's/^enable-rcon=.*/enable-rcon=true/' "$SERVER_PROPERTIES"
else
    echo "enable-rcon=true" >>"$SERVER_PROPERTIES"
fi

# rcon.port
if grep -q "^rcon.port=" "$SERVER_PROPERTIES"; then
    sed -i "s/^rcon.port=.*/rcon.port=$RCON_PORT/" "$SERVER_PROPERTIES"
else
    echo "rcon.port=$RCON_PORT" >>"$SERVER_PROPERTIES"
fi

# rcon.password
if grep -q "^rcon.password=" "$SERVER_PROPERTIES"; then
    sed -i "s/^rcon.password=.*/rcon.password=$RCON_PASSWORD/" "$SERVER_PROPERTIES"
else
    echo "rcon.password=$RCON_PASSWORD" >>"$SERVER_PROPERTIES"
fi

echo "RCON setup complete."
echo "  Port: $RCON_PORT"
echo "  Password: $RCON_PASSWORD"
