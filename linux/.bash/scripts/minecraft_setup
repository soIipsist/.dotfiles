#!/bin/bash

MCDIR="/home/steam/minecraft_server"
PROPERTIES_FILE="$MCDIR/server.properties"
RCON_PORT=25575

mkdir -p "$MCDIR"
cd "$MCDIR" || exit 1

# If the server.properties file doesn't exist, create it
if [ ! -f "$PROPERTIES_FILE" ]; then
    echo "server.properties not found, creating a new one..."
    cat >"$PROPERTIES_FILE" <<EOF
# Minecraft server properties
enable-rcon=true
rcon.port=$RCON_PORT
rcon.password=$RCON_PASS
enable-query=false
EOF
    echo "Created new server.properties with RCON enabled."
    exit 0
fi

# Backup existing server.properties
cp "$PROPERTIES_FILE" "$PROPERTIES_FILE.bak.$(date +%Y%m%d%H%M%S)"

# Ensure RCON settings are set
echo "Ensuring RCON settings are configured..."

# enable-rcon
if grep -q "^enable-rcon=" "$PROPERTIES_FILE"; then
    sed -i 's/^enable-rcon=.*/enable-rcon=true/' "$PROPERTIES_FILE"
else
    echo "enable-rcon=true" >>"$PROPERTIES_FILE"
fi

# rcon.port
if grep -q "^rcon.port=" "$PROPERTIES_FILE"; then
    sed -i "s/^rcon.port=.*/rcon.port=$RCON_PORT/" "$PROPERTIES_FILE"
else
    echo "rcon.port=$RCON_PORT" >>"$PROPERTIES_FILE"
fi

# rcon.password
if grep -q "^rcon.password=" "$PROPERTIES_FILE"; then
    sed -i "s/^rcon.password=.*/rcon.password=$RCON_PASS/" "$PROPERTIES_FILE"
else
    echo "rcon.password=$RCON_PASS" >>"$PROPERTIES_FILE"
fi

echo "RCON setup complete."
echo "  Port: $RCON_PORT"
echo "  Password: $RCON_PASS"
