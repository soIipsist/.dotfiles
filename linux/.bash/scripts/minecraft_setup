#!/bin/bash

if [ -z "$SERVER_PROPERTIES" ]; then
    SERVER_PROPERTIES="$MC_DIR/server.properties"
fi

if [ -z "$RCON_PORT" ]; then
    RCON_PORT=25575
fi

if [ -z "$GAME_MODE" ]; then
    GAME_MODE="survival"
fi

if [ "$RESTART_WORLD" -eq 1 ]; then
    find "$MC_DIR" -mindepth 1 -maxdepth 1 ! -name "$JAR" -exec rm -rf {} +
    touch "$MC_DIR/eula.txt"

    echo "Creating a new world..."
fi

# If the server.properties file doesn't exist, create it
if [ ! -f "$SERVER_PROPERTIES" ]; then
    echo "server.properties not found, creating a new one..."
    cat >"$SERVER_PROPERTIES" <<EOF
# Minecraft server properties
enable-rcon=true
rcon.port=$RCON_PORT
rcon.password=$RCON_PASSWORD
enable-query=false
EOF
    echo "Created new server.properties with RCON enabled."
    exit 0
fi

# Ensure RCON settings are set
echo "Ensuring RCON settings are configured..."

# enable-rcon
if grep -q "^enable-rcon=" "$SERVER_PROPERTIES"; then
    sed -i 's/^enable-rcon=.*/enable-rcon=true/' "$SERVER_PROPERTIES"
else
    echo "enable-rcon=true" >>"$SERVER_PROPERTIES"
fi

# rcon.port
if grep -q "^rcon.port=" "$SERVER_PROPERTIES"; then
    sed -i "s/^rcon.port=.*/rcon.port=$RCON_PORT/" "$SERVER_PROPERTIES"
else
    echo "rcon.port=$RCON_PORT" >>"$SERVER_PROPERTIES"
fi

# rcon.password
if grep -q "^rcon.password=" "$SERVER_PROPERTIES"; then
    sed -i "s/^rcon.password=.*/rcon.password=$RCON_PASSWORD/" "$SERVER_PROPERTIES"
else
    echo "rcon.password=$RCON_PASSWORD" >>"$SERVER_PROPERTIES"
fi

# set game mode
if grep -q "^gamemode=" "$SERVER_PROPERTIES"; then
    sed -i "s/^gamemode=.*/gamemode=$GAME_MODE/" "$SERVER_PROPERTIES"
else
    echo "gamemode=$GAME_MODE" >>"$SERVER_PROPERTIES"
fi

echo "RCON setup complete."
echo "  Port: $RCON_PORT"
echo "  Password: $RCON_PASSWORD"
