#!/bin/bash

config_file="${1:-}"
service_name="${config_file##*/}"
service_name="${service_name%.conf}"
uid=$(id -u)
log_file="/tmp/$uid/$service_name/$service_name.txt"
mkdir -p "$(dirname "$log_file")"

if [ -z "$config_file" ] || [ ! -f "$config_file" ]; then
    echo "Usage: $0 /path/to/config_file.conf"
    echo "Error: No valid config file provided."
    exit 1
fi

echo "Generating config file from: $config_file" >"$log_file"
echo "[DEBUG] Environment before substitution:" >>"$log_file"
env >>"$log_file"

filename="$(basename "$config_file")"
dest_conf="/etc/default/$filename"
export uid

if envsubst <"$config_file" >"$dest_conf"; then
    echo "✔ $filename generated at $dest_conf" >>"$log_file"
    echo "[DEBUG] Substitution output for $filename:" >>"$log_file"
    envsubst <"$config_file" >>"$log_file"
else
    echo "✖ Failed to generate $filename" >>"$log_file"
    exit 1
fi

echo "Done. See log: $log_file"
echo "Restarting service..."
sudo systemctl restart $service_name
