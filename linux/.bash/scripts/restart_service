#!/bin/bash

if [ -f "$HOME/.zshrc" ]; then
    source "$HOME/.zshrc"
fi

config_file="${1:-}"
log_file="/tmp/downloads_log.txt"

if [ -z "$config_file" ] || [ ! -f "$config_file" ]; then
    echo "Usage: $0 /path/to/config_file.conf"
    echo "Error: No valid config file provided."
    exit 1
fi

echo "Generating config file from: $config_file" >"$log_file"
echo "[DEBUG] Environment before substitution:" >>"$log_file"
env >>"$log_file"

filename="$(basename "$config_file")"
dest_conf="/etc/default/$filename"

temp_file="$(mktemp)"
if envsubst <"$config_file" >"$temp_file"; then
    sudo cp "$temp_file" "$dest_conf"
    echo "✔ $filename generated at $dest_conf" >>"$log_file"
    echo "[DEBUG] Substitution output for $filename:" >>"$log_file"
    cat "$temp_file" >>"$log_file"
else
    echo "✖ Failed to generate $filename" >>"$log_file"
    exit 1
fi

rm "$temp_file"
echo "Done. See log: $log_file"
