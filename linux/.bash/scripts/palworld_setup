#!/bin/bash
# Pre-start script for Palworld: generate full ServerSettings.ini
LOG_PATH="/var/log/palworld.log"
if [ -z "$CONFIG_FILE" ]; then
    echo "Palworld config file was not found" >>"$LOG_PATH"
    exit 0
fi

if [ -z "$PUBLIC_IP" ]; then
    PUBLIC_IP="$(curl -s https://ifconfig.me)"
fi

envsubst < <(
    cat <<'EOF'
[/Script/Pal.PalGameWorldSettings]
OptionSettings=(Difficulty=$DIFFICULTY,RandomizerType=$RANDOMIZER_TYPE,RandomizerSeed=$RANDOMIZER_SEED,bIsRandomizerPalLevelRandom=False,DayTimeSpeedRate=$DAY_TIME_SPEED_RATE,NightTimeSpeedRate=$NIGHT_TIME_SPEED_RATE,ExpRate=$EXP_RATE,PalCaptureRate=$PAL_CAPTURE_RATE,PalSpawnNumRate=$PAL_SPAWN_NUM_RATE,PalDamageRateAttack=$PAL_DAMAGE_RATE_ATTACK,PalDamageRateDefense=$PAL_DAMAGE_RATE_DEFENSE,PlayerDamageRateAttack=$PLAYER_DAMAGE_RATE_ATTACK,PlayerDamageRateDefense=$PLAYER_DAMAGE_RATE_DEFENSE,PlayerStomachDecreaceRate=1.000000,PlayerStaminaDecreaceRate=1.000000,PlayerAutoHPRegeneRate=1.000000,PlayerAutoHpRegeneRateInSleep=1.000000,PalStomachDecreaceRate=1.000000,PalStaminaDecreaceRate=1.000000,PalAutoHPRegeneRate=1.000000,PalAutoHpRegeneRateInSleep=1.000000,BuildObjectHpRate=1.000000,BuildObjectDamageRate=1.000000,BuildObjectDeteriorationDamageRate=1.000000,CollectionDropRate=1.000000,CollectionObjectHpRate=1.000000,CollectionObjectRespawnSpeedRate=1.000000,EnemyDropItemRate=1.000000,DeathPenalty=$DEATH_PENALTY,bEnablePlayerToPlayerDamage=$ENABLE_PLAYER_TO_PLAYER_DAMAGE,bEnableFriendlyFire=$ENABLE_FRIENDLY_FIRE,bEnableInvaderEnemy=$ENABLE_INVADER_ENEMY,bActiveUNKO=False,bEnableAimAssistPad=True,bEnableAimAssistKeyboard=False,DropItemMaxNum=3000,DropItemMaxNum_UNKO=100,BaseCampMaxNum=$BASECAMP_MAX_NUM,BaseCampWorkerMaxNum=$BASECAMP_WORKER_MAX_NUM,DropItemAliveMaxHours=1.000000,bAutoResetGuildNoOnlinePlayers=$AUTO_RESET_GUILD_NO_ONLINE_PLAYERS,AutoResetGuildTimeNoOnlinePlayers=$AUTO_RESET_GUILD_TIME_NO_ONLINE_PLAYERS,GuildPlayerMaxNum=$GUILD_PLAYER_MAX_NUM,BaseCampMaxNumInGuild=$BASECAMP_MAX_NUM_IN_GUILD,PalEggDefaultHatchingTime=$PAL_EGG_DEFAULT_HATCHING_TIME,WorkSpeedRate=$WORK_SPEED_RATE,AutoSaveSpan=$AUTO_SAVE_SPAN,bIsMultiplay=False,bIsPvP=False,bHardcore=False,bPalLost=False,bCharacterRecreateInHardcore=False,bCanPickupOtherGuildDeathPenaltyDrop=False,bEnableNonLoginPenalty=$ENABLE_NONLOGIN_PENALTY,bEnableFastTravel=$ENABLE_FAST_TRAVEL,bIsStartLocationSelectByMap=$IS_START_LOCATION_SELECT_BY_MAP,bExistPlayerAfterLogout=False,bEnableDefenseOtherGuildPlayer=False,bInvisibleOtherGuildBaseCampAreaFX=False,bBuildAreaLimit=$BUILD_AREA_LIMIT,ItemWeightRate=$ITEM_WEIGHT_RATE,CoopPlayerMaxNum=$COOP_PLAYER_MAX_NUM,ServerPlayerMaxNum=$SERVER_PLAYER_MAX_NUM,ServerName="$SERVER_NAME",ServerDescription="$SERVER_DESC",AdminPassword="$ADMIN_PASS",ServerPassword="$SERVER_PASS",PublicPort=$PUBLIC_PORT,PublicIP="$PUBLIC_IP",RCONEnabled=$RCON_ENABLED,RCONPort=$RCON_PORT,Region="$REGION",bUseAuth=True,BanListURL="$BANLIST_URL",RESTAPIEnabled=$RESTAPI_ENABLED,RESTAPIPort=$RESTAPI_PORT,bShowPlayerList=$SHOW_PLAYER_LIST,ChatPostLimitPerMinute=30,CrossplayPlatforms=(Steam,Xbox,PS5,Mac),bIsUseBackupSaveData=True,LogFormatType=$LOG_FORMAT_TYPE,bIsShowJoinLeftMessage=$IS_SHOW_JOIN_LEFT_MESSAGE,SupplyDropSpan=$SUPPLY_DROP_SPAN,EnablePredatorBossPal=True,MaxBuildingLimitNum=0,ServerReplicatePawnCullDistance=15000.000000,bAllowGlobalPalboxExport=$ALLOW_GLOBAL_PALBOX_EXPORT,bAllowGlobalPalboxImport=$ALLOW_GLOBAL_PALBOX_IMPORT,EquipmentDurabilityDamageRate=1.000000,ItemContainerForceMarkDirtyInterval=1.000000,ItemCorruptionMultiplier=1.000000)
EOF
) >"$CONFIG_FILE"

chown steam:steam "$CONFIG_FILE"
chmod 600 "$CONFIG_FILE"

echo "Palworld ServerSettings.ini generated at $CONFIG_FILE"
