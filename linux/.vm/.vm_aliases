vm_reset() {
    # destroy and undefine all VMs (with storage)
    local vms vm

    vms=$(sudo virsh list --all --name 2>/dev/null) || {
        echo "No VMs found or virsh failed."
        return 0
    }

    [ -z "$vms" ] && return 0

    echo "Cleaning up VMs:"
    printf '  %s\n' $vms

    while IFS= read -r vm; do
        [[ -z "$vm" ]] && continue

        echo -n "  → $vm ... "
        sudo virsh destroy "$vm" >/dev/null 2>&1 && echo "destroyed" || echo "not running"

        if sudo virsh undefine "$vm" --remove-all-storage >/dev/null 2>&1; then
            echo "    undefine + storage removed"
        else
            echo "    undefine failed (maybe already gone)"
        fi

    done <<<"$vms"

    echo "Cleanup complete."
}

vm_init() {
    # creates a virtual machine with libvirt (uses ubuntu 24.04 as base image for now)

    NAME=${1:-ubuntu_vm}
    SSH_KEY=${2:-$(cat ~/.ssh/id_ed25519.pub)}
    VM_IMG=${3:-"https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"}
    CLEAN_VM=${4:-1}
    IMG="/var/lib/libvirt/images/${NAME}.qcow2"
    CLOUD_DIR="/var/lib/libvirt/cloud-init"
    CLOUD_ISO="${CLOUD_DIR}/cidata.iso"
    BASE_IMG="/var/lib/libvirt/images/ubuntu2404-base.qcow2"

    # 1. clean old VM (if any)

    if [ "$CLEAN_VM" = "1" ]; then
        echo "Destroying old VMs..."
        sudo virsh snapshot-delete "$NAME" --current --children --metadata --disk-only
        sudo virsh destroy "$NAME" 2>/dev/null || true
        sudo virsh undefine "$NAME" --remove-all-storage 2>/dev/null || true
        sudo rm -rf "$CLOUD_DIR" "$IMG"
    fi

    # 2. download base cloud image

    if [ ! -f "$BASE_IMG" ]; then
        echo "Downloading Ubuntu 24.04 cloud image..."
        sudo wget -qO "$BASE_IMG" \
            https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img
    fi

    # 3. create cloud‑init files

    sudo mkdir -p "$CLOUD_DIR"

    printf '%s\n' \
        '#cloud-config' \
        "hostname: $NAME" \
        "fqdn: $NAME.local" \
        'users:' \
        '  - name: ubuntu' \
        '    sudo: ALL=(ALL) NOPASSWD:ALL' \
        '    plain_text_passwd: ubuntu123' \
        '    passwd: ubuntu123' \
        '    ssh-authorized-keys:' \
        "      - $SSH_KEY" \
        '    lock_passwd: false' \
        '    shell: /bin/bash' \
        'chpasswd: { expire: false }' \
        'ssh_pwauth: false' \
        'packages:' \
        '  - transmission-cli' \
        '  - transmission-daemon' \
        '  - net-tools' \
        '  - iproute2' \
        '  - wget' \
        '  - curl' \
        '  - vim' \
        '  - less' \
        '  - file' \
        '  - openssh-server' |
        sudo tee "${CLOUD_DIR}/user-data" >/dev/null

    printf '%s\n' \
        "instance-id: $NAME" \
        "local-hostname: $NAME" |
        sudo tee "${CLOUD_DIR}/meta-data" >/dev/null

    # 4. build cidata ISO
    sudo apt-get install -y genisoimage
    sudo genisoimage -output "$CLOUD_ISO" -volid cidata -joliet -rock \
        "${CLOUD_DIR}/user-data" "${CLOUD_DIR}/meta-data"

    # 5. QCOW2 overlay disk
    sudo qemu-img create -f qcow2 -F qcow2 -b "$BASE_IMG" "$IMG" 20G

    # 6. start VM with sudo virt-install

    sudo virt-install \
        --name "$NAME" \
        --memory 3072 \
        --vcpus 2 \
        --disk path="$IMG",format=qcow2,bus=virtio,cache=none \
        --disk "$CLOUD_ISO",device=cdrom \
        --os-variant ubuntu24.04 \
        --network network=default,model=virtio \
        --graphics none \
        --import \
        --noautoconsole

    # 7. get VM's IP (max 90 s)

    MAC=$(sudo virsh dumpxml "$NAME" | grep -o "mac address='[^']*" | cut -d"'" -f2 | tr '[:upper:]' '[:lower:]')
    echo "MAC address: $MAC"
    echo "Waiting for IP (max 90 s)..."

    for i in $(seq 1 90); do
        IP=$(arp -an | grep -i "$MAC" | awk '{print $2}' | tr -d '()' || true)
        [ -n "$IP" ] && break
        sleep 1
    done

    if [ -z "$IP" ]; then
        echo "ERROR: No IP after 90 s"
        echo "Debug:"
        sudo virsh domblklist "$NAME"
        echo "Try: sudo virsh console $NAME  (Ctrl+] to exit)"
        return 1
    fi

    echo "IP found: $IP"
    echo "SSH command: ssh ubuntu@$IP   (password: ubuntu123)"

}