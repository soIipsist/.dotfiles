export VM_DIR="/var/lib/libvirt/images"

vm_reset() {
    local vms=("$@")
    local vm

    if ((${#vms[@]} == 0)); then
        echo "No VMs specified."
        return 0
    fi

    echo "Processing: ${vms[*]}"
    echo

    for vm in "${vms[@]}"; do
        if [ ! -d "$VM_DIR/$vm" ]; then
            echo "VM '$vm' does not exist → skipping"
            continue
        fi

        printf '  • %-20s ' "$vm"
        sudo virsh destroy "$vm" &>/dev/null && echo -n "stopped "
        if sudo virsh undefine "$vm" --remove-all-storage --nvram &>/dev/null; then
            echo "removed"
        else
            echo "already gone"
        fi
    done

    echo
    echo "Done."
}

get_qcow() {
    local src="$1"
    local dst="$2"
    local tmp_img

    case "$src" in
    *cloudimg*.img | *-server-cloudimg-*.img)
        echo "Cloud image detected → do NOT convert."
        sudo cp "$src" "$dst"
        return
        ;;
    *.raw)
        echo "Converting raw .raw → qcow2..."
        sudo qemu-img convert -f raw -O qcow2 "$src" "$dst"
        ;;
    *.tar.xz | *.tar.gz | *.tgz)
        echo "Extracting tar archive → converting first .img or .raw to qcow2..."
        tmp_dir=$(mktemp -d)
        sudo tar -xf "$src" -C "$tmp_dir"
        img_file=$(find "$tmp_dir" -type f \( -name "*.img" -o -name "*.raw" \) | head -n 1)
        [ -z "$img_file" ] && {
            echo "No .img or .raw file found in archive"
            rm -rf "$tmp_dir"
            return 1
        }
        sudo qemu-img convert -f raw -O qcow2 "$img_file" "$dst"
        rm -rf "$tmp_dir"
        ;;
    *.xz | *.img.xz)
        echo "Decompressing .xz → converting to qcow2..."
        tmp_img=$(mktemp --suffix=.img)
        sudo unxz -c "$src" | sudo tee "$dst" >/dev/null
        sudo qemu-img convert -f raw -O qcow2 "$tmp_img" "$dst"
        rm -f "$tmp_img"
        ;;
    *.img)
        echo "Converting raw .img → qcow2..."
        sudo qemu-img convert -f raw -O qcow2 "$src" "$dst"
        ;;

    *.qcow2)
        echo "Using existing qcow2..."
        sudo mv "$src" "$dst"
        ;;

    *)
        echo "Copying image as-is..."
        sudo mv "$src" "$dst"
        ;;
    esac
}

vm_init() {
    # Default parameters
    NAME="ubuntu_vm"
    MEMORY=3072
    VCPUS=2
    DISK_SIZE=20
    IMAGE="" # QCOW2 or raw
    ISO=""   # Boot ISO (Windows or Linux installer)
    USER_DATA=""
    META_DATA=""
    CLEAN=1
    USE_GRAPHICS=0
    SSH_KEY=""

    # image links:
    # "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"

    # Parse args: --name foo --image path ... etc
    while [ $# -gt 0 ]; do
        case "$1" in
        --name)
            NAME="$2"
            shift
            ;;
        --memory)
            MEMORY="$2"
            shift
            ;;
        --vcpus)
            VCPUS="$2"
            shift
            ;;
        --disk-size)
            DISK_SIZE="$2"
            shift
            ;;
        --image)
            IMAGE="$2"
            shift
            ;;
        --iso)
            ISO="$2"
            shift
            ;;
        --ssh-key)
            SSH_KEY="$2"
            shift
            ;;
        --no-clean) CLEAN=0 ;;
        *)
            echo "Unknown arg: $1"
            return 1
            ;;
        esac
        shift
    done

    if [ -z "$NAME" ]; then
        echo "ERROR: You must provide --name"
        return 1
    fi

    # Determine USER_DATA and META_DATA from vm name
    if [ -n "$VM_DIR" ]; then
        VM_METADATA_DIR="$VM_DIR/$NAME"
        for file in "$VM_METADATA_DIR"/*; do
            if [[ "$file" == *.iso && -z "$ISO" ]]; then
                ISO="$file"
                echo "Setting iso file to $ISO."
            fi

            if [[ "$(basename "$file")" == "user-data" ]]; then
                USER_DATA="$file"
                echo "Setting user-data file to $USER_DATA."
            fi

            if [[ "$(basename "$file")" == "meta-data" ]]; then
                META_DATA="$file"
                echo "Setting meta-data file to $META_DATA."
            fi
        done
    fi

    if [ -z "$IMAGE" ] && [ -z "$ISO" ]; then
        echo "ERROR: You must provide --image or --iso"
        return 1
    fi

    IMG="/var/lib/libvirt/images/${NAME}.qcow2"
    CLOUD_DIR="/var/lib/libvirt/cloud-init-${NAME}"
    CLOUD_ISO="${CLOUD_DIR}/cidata.iso"

    if [ "$CLEAN" = 1 ]; then
        sudo virsh destroy "$NAME" 2>/dev/null || true
        sudo virsh undefine "$NAME" --remove-all-storage 2>/dev/null || true
        sudo rm -rf "$IMG" "$CLOUD_DIR"
    fi

    sudo mkdir -p "$CLOUD_DIR"

    # Download remote qcow2 if URL provided
    if [[ "$IMAGE" =~ ^https?:// ]]; then
        echo "Downloading image from URL..."
        filename=$(basename "$IMAGE")
        tmp=$(sudo mktemp --suffix=$filename)
        sudo wget -q --show-progress -O "$tmp" "$IMAGE"
        get_qcow "$tmp" "$IMG"
        sudo rm "$tmp"
    elif [ -n "$IMAGE" ]; then
        echo "Using local image: $IMAGE"
        get_qcow "$IMAGE" "$IMG"
    fi

    # Create cloud-init ISO if provided
    if [ -n "$USER_DATA" ] && [ -n "$META_DATA" ]; then
        echo "Using cloud-init"
        sudo cp "$USER_DATA" "${CLOUD_DIR}/user-data"

        if [ -n "$SSH_KEY" ]; then
            echo "Updating SSH key in user-data"
            sudo sed -i "/ssh-authorized-keys:/,/^[^ ]/c\    ssh-authorized-keys:\n      - $SSH_KEY" \
                "${CLOUD_DIR}/user-data"
        fi
        sudo cp "$META_DATA" "${CLOUD_DIR}/meta-data"
        sudo genisoimage -output "$CLOUD_ISO" -volid cidata -joliet -rock \
            "${CLOUD_DIR}/user-data" "${CLOUD_DIR}/meta-data"
        CLOUD_DISK=(--disk $CLOUD_ISO,device=cdrom --import)
    else
        CLOUD_DISK=()
    fi

    GRAPHICS=()
    if [ "$USE_GRAPHICS" = 1 ]; then
        GRAPHICS=(--graphics vnc,listen=127.0.0.1)
    else
        GRAPHICS_OPT=(--graphics none)
    fi

    set -x
    if [ -n "$ISO" ]; then
        # Classic ISO installation
        sudo virt-install \
            --name "$NAME" \
            --memory "$MEMORY" \
            --vcpus "$VCPUS" \
            --disk path="$IMG",format=qcow2,bus=virtio,size="$DISK_SIZE" \
            --cdrom "$ISO" \
            --boot cdrom,hd \
            --network network=default,model=virtio "${GRAPHICS[@]}" \
            --os-variant detect=on \
            --noautoconsole
    else
        # Cloud image import
        sudo virt-install \
            --name "$NAME" \
            --memory "$MEMORY" \
            --vcpus "$VCPUS" \
            --import \
            --disk path="$IMG",format=qcow2,bus=virtio \
            "${CLOUD_DISK[@]}" \
            --boot hd \
            --network network=default,model=virtio \
            "${GRAPHICS[@]}" \
            --os-variant detect=on \
            --noautoconsole
    fi

    set +x
    echo "VM launched."

    if [ "$USE_GRAPHICS" = 1 ]; then
        echo "To access UI via VNC:"
        echo " ssh -L 5900:127.0.0.1:5900 user@<host>"
        echo " vncviewer 127.0.0.1:5900"
    else
        echo "Headless mode. Use: sudo virsh console $NAME"
    fi

    MAC=$(sudo virsh dumpxml "$NAME" | grep -o "mac address='[^']*" | cut -d"'" -f2 | tr '[:upper:]' '[:lower:]')
    echo "MAC address: $MAC"
    echo "Waiting for IP (max 90 s)..."

    for i in $(seq 1 90); do
        IP=$(arp -an | grep -i "$MAC" | awk '{print $2}' | tr -d '()' || true)
        [ -n "$IP" ] && break
        sleep 1
    done

    if [ -z "$IP" ]; then
        echo "ERROR: No IP after 90 s"
        echo "Debug:"
        sudo virsh domblklist "$NAME"
        echo "Try: sudo virsh console $NAME  (Ctrl+] to exit)"
        return 1
    fi

    echo "IP found: $IP"
    echo "SSH command: ssh ubuntu@$IP   (password: ubuntu123)"
}
