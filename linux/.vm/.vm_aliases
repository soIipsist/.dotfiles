export VM_DIR="$HOME/isos"

vm_reset() {
    # destroy and undefine all VMs (with storage)
    local vms vm

    vms=$(sudo virsh list --all --name 2>/dev/null) || {
        echo "No VMs found or virsh failed."
        return 0
    }

    [ -z "$vms" ] && return 0

    echo "Cleaning up VMs:"
    printf '  %s\n' $vms

    while IFS= read -r vm; do
        [[ -z "$vm" ]] && continue

        echo -n "  â†’ $vm ... "
        sudo virsh destroy "$vm" >/dev/null 2>&1 && echo "destroyed" || echo "not running"

        if sudo virsh undefine "$vm" --remove-all-storage >/dev/null 2>&1; then
            echo "    undefine + storage removed"
        else
            echo "    undefine failed (maybe already gone)"
        fi

    done <<<"$vms"

    echo "Cleanup complete."
}

vm_init() {
    # Default parameters
    NAME="ubuntu_vm"
    MEMORY=3072
    VCPUS=2
    DISK_SIZE=20G
    IMAGE="" # QCOW2 or raw
    ISO=""   # Boot ISO (Windows or Linux installer)
    USER_DATA=""
    META_DATA=""
    CLEAN=1
    USE_GRAPHICS=0
    SSH_KEY=""

    # image links:
    # "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"

    # Parse args: --name foo --image path ... etc
    while [ $# -gt 0 ]; do
        case "$1" in
        --name)
            NAME="$2"
            shift
            ;;
        --memory)
            MEMORY="$2"
            shift
            ;;
        --vcpus)
            VCPUS="$2"
            shift
            ;;
        --disk-size)
            DISK_SIZE="$2"
            shift
            ;;
        --image)
            IMAGE="$2"
            shift
            ;;
        --iso)
            ISO="$2"
            shift
            ;;
        --ssh-key)
            SSH_KEY="$2"
            shift
            ;;
        --no-clean) CLEAN=0 ;;
        *)
            echo "Unknown arg: $1"
            return 1
            ;;
        esac
        shift
    done

    if [ -z "$NAME" ]; then
        echo "ERROR: You must provide --name"
        return 1
    fi

    # Determine USER_DATA and META_DATA from vm name
    if [ -n "$VM_DIR" ]; then
        VM_METADATA_DIR="$VM_DIR/$NAME"
        for file in "$VM_METADATA_DIR"/*; do
            if [[ "$file" == *.iso && -z "$ISO" ]]; then
                ISO="$file"
                echo "Setting iso file to $ISO."
            fi

            if [[ "$(basename "$file")" == "user-data" ]]; then
                USER_DATA="$file"
                echo "Setting user-data file to $USER_DATA."
            fi

            if [[ "$(basename "$file")" == "meta-data" ]]; then
                META_DATA="$file"
                echo "Setting meta-data file to $META_DATA."
            fi
        done
    fi

    if [ -z "$IMAGE" ] && [ -z "$ISO" ]; then
        echo "ERROR: You must provide --image or --iso"
        return 1
    fi

    IMG="/var/lib/libvirt/images/${NAME}.qcow2"
    CLOUD_DIR="/var/lib/libvirt/cloud-init-${NAME}"
    CLOUD_ISO="${CLOUD_DIR}/cidata.iso"

    if [ "$CLEAN" = 1 ]; then
        sudo virsh destroy "$NAME" 2>/dev/null || true
        sudo virsh undefine "$NAME" --remove-all-storage 2>/dev/null || true
        sudo rm -rf "$IMG" "$CLOUD_DIR"
    fi

    sudo mkdir -p "$CLOUD_DIR"

    # Download remote qcow2 if URL provided
    if [[ "$IMAGE" =~ ^https?:// ]]; then
        echo "Downloading image..."
        sudo wget -qO "$IMG" "$IMAGE"
    elif [ -n "$IMAGE" ]; then
        echo "Copying disk image..."
        sudo cp "$IMAGE" "$IMG"
    fi

    # Create cloud-init ISO if provided
    if [ -n "$USER_DATA" ] && [ -n "$META_DATA" ]; then
        echo "Using cloud-init"
        sudo cp "$USER_DATA" "${CLOUD_DIR}/user-data"

        if [ -n "$SSH_KEY" ]; then
            echo "Updating SSH key in user-data"
            sudo sed -i "/ssh-authorized-keys:/,/^[^ ]/c\    ssh-authorized-keys:\n      - $SSH_KEY" \
                "${CLOUD_DIR}/user-data"
        fi
        sudo cp "$META_DATA" "${CLOUD_DIR}/meta-data"
        sudo genisoimage -output "$CLOUD_ISO" -volid cidata -joliet -rock \
            "${CLOUD_DIR}/user-data" "${CLOUD_DIR}/meta-data"
        CLOUD_DISK="--disk $CLOUD_ISO,device=cdrom"
    else
        CLOUD_DISK=""
    fi

    # Prepare ISO if boot installer is provided
    if [ -n "$ISO" ]; then
        INSTALL_ISO="--cdrom $ISO"
    else
        INSTALL_ISO=""
    fi

    if [ "$USE_GRAPHICS" = 1 ]; then
        GRAPHICS="--graphics vnc,listen=127.0.0.1"
    else
        GRAPHICS="--graphics none"
    fi

    if [ -n "$INSTALL_ISO" ]; then
        CMD="$INSTALL_ISO"
    else
        CMD="$CLOUD_DISK"
    fi

    # Start VM
    sudo virt-install \
        --name "$NAME" \
        --memory "$MEMORY" \
        --vcpus "$VCPUS" \
        --disk path="$IMG",format=qcow2,bus=virtio \
        $CMD \
        --network network=default,model=virtio \
        $GRAPHICS \
        --os-variant detect=on \
        --import \
        --noautoconsole

    echo "VM launched."

    if [ "$USE_GRAPHICS" = 1 ]; then
        echo "To access UI via VNC:"
        echo " ssh -L 5900:127.0.0.1:5900 user@<host>"
        echo " vncviewer 127.0.0.1:5900"
    else
        echo "Headless mode. Use: sudo virsh console $NAME"
    fi

}
