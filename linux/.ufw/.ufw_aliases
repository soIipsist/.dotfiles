ufw_open_outbound() {
    # opens outbound connections (good for VM downloads)
    sudo ufw --force reset
    sudo ufw default deny incoming
    sudo ufw default deny outgoing

    if [ -n "$1" ]; then
        HOST_GATEWAY="$1"
    else
        HOST_GATEWAY=$(ip route | awk '/default/ {print $3}')
    fi

    echo "Detected host NAT gateway: $HOST_GATEWAY"

    # Outbound to NAT gateway only
    sudo ufw allow out to "$HOST_GATEWAY" proto tcp comment "gateway for NAT"
    sudo ufw allow out to "$HOST_GATEWAY" proto udp comment "gateway for NAT"

    # allow ssh from host to VM
    sudo ufw allow in from "$HOST_GATEWAY" to any port 22 proto tcp

    # DNS
    sudo ufw allow out to any port 53 proto udp

    # HTTP / HTTPS
    sudo ufw allow out 80/tcp
    sudo ufw allow out 443/tcp

    # transmission protocol
    sudo ufw allow out 51413/tcp
    sudo ufw allow out 51413/udp

    sudo ufw --force enable
    sudo ufw reload
    sudo ufw status verbose
}

ufw_restrict() {
    if [ -n "$1" ]; then
        HOST_GATEWAY="$1"
    else
        HOST_GATEWAY=$(ip route | awk '/default/ {print $3}')
    fi

    echo "Detected host gateway: ${HOST_GATEWAY:-<none>}"

    sudo ufw --force reset
    sudo ufw default deny incoming
    sudo ufw default deny outgoing

    # allow SSH
    sudo ufw allow in from "$HOST_GATEWAY" to any port 22 proto tcp

    # disable IPV6
    sudo sed -i 's/IPV6=yes/IPV6=no/' /etc/default/ufw

    # disable ICMP
    sudo sed -i -E 's/^\s*-A\ ufw-before-input\ -p\ icmp\ --icmp-type.*ACCEPT\s*/#\ \0/g' /etc/ufw/before.rules
    sudo sed -i -E 's/^\s*-A\ ufw-before-forward\ -p\ icmp\ --icmp-type.*ACCEPT\s*/#\ \0/g' /etc/ufw/before.rules

    sudo ufw --force enable
    sudo ufw reload
    sudo ufw status verbose
}

ufw_lockdown() {
    sudo ufw --force reset
    sudo ufw default deny incoming
    sudo ufw default deny outgoing

    TUN_IF=$(ip route get 8.8.8.8 | awk '{print $5}' | head -1) # auto-detects wg0/tun0
    sudo ufw allow out on "$TUN_IF" from any to any
    sudo ufw allow in on "$TUN_IF" to any port 51413

    sudo ufw allow in on lo
    sudo ufw allow out on lo

    NAT_GW=$(ip route | awk '/192.168.122/ {print $3}')
    [ -n "$NAT_GW" ] && sudo ufw allow in from "$NAT_GW" to any port 22 proto tcp

    sudo ufw --force enable
    sudo ufw reload
    sudo ufw status verbose
}

ufw_reset_all() {
    sudo ufw --force reset

    # enable IPV6
    sudo sed -i 's/IPV6=no/IPV6=yes/' /etc/default/ufw

    # enable ICMP
    sudo sed -i -E 's/^#\s*(-A ufw-before-input -p icmp --icmp-type.*ACCEPT)/\1/' /etc/ufw/before.rules
    sudo sed -i -E 's/^#\s*(-A ufw-before-forward -p icmp --icmp-type.*ACCEPT)/\1/' /etc/ufw/before.rules

    sudo ufw reload
    sudo ufw status verbose
}

ufw_status() {
    echo "=== Detecting UFW Mode ==="

    UFW_STATUS=$(sudo ufw status verbose 2>/dev/null || true)
    DEFAULT_LINE=$(echo "$UFW_STATUS" | grep -i '^Default:' || echo "")

    POLICIES=$(echo "$DEFAULT_LINE" | grep -oE 'deny|allow' || true)
    IN_POLICY=$(echo "$POLICIES" | sed -n '1p' || echo "unknown")
    OUT_POLICY=$(echo "$POLICIES" | sed -n '2p' || echo "unknown")

    IPV6=$(grep "^IPV6=" /etc/default/ufw | cut -d= -f2)
    ICMP_INPUT_ENABLED=$(sudo grep -E '^#\s*-A ufw-before-input -p icmp' /etc/ufw/before.rules >/dev/null && echo no || echo yes)
    ICMP_FORWARD_ENABLED=$(sudo grep -E '^#\s*-A ufw-before-forward -p icmp' /etc/ufw/before.rules >/dev/null && echo no || echo yes)
    HOST_GATEWAY=$(ip route | awk '/default/ {print $3}')
    HAS_SSH_FROM_GATEWAY=$([ -n "$HOST_GATEWAY" ] && echo "$UFW_STATUS" | grep -i 'ALLOW IN' | grep -E '22(/tcp|/udp)?' | grep -F -q "$HOST_GATEWAY" && echo yes || echo no)
    HAS_HTTP_HTTPS=$(sudo ufw status | grep -E "80/tcp|443/tcp" >/dev/null && echo yes || echo no)
    HAS_DNS=$(sudo ufw status | grep -E "53.*ALLOW OUT" >/dev/null && echo yes || echo no)

    echo "Inbound policy:   $IN_POLICY"
    echo "Outbound policy:  $OUT_POLICY"
    echo "IPv6 enabled:     $IPV6"
    echo "ICMP enabled:    input=$ICMP_INPUT_ENABLED forward=$ICMP_FORWARD_ENABLED"
    echo "SSH from gateway: $HAS_SSH_FROM_GATEWAY"
    echo "HTTP/HTTPS:       $HAS_HTTP_HTTPS"
    echo "DNS allowed:      $HAS_DNS"

    echo
    echo "=== Determining Mode ==="

    if [ "$IN_POLICY" = "deny" ] &&
        [ "$OUT_POLICY" = "deny" ] &&
        [ "$HAS_SSH_FROM_GATEWAY" = "yes" ] &&
        [ "$ICMP_INPUT_ENABLED" = "no" ] &&
        [ "$IPV6" = "no" ]; then
        echo "MODE: restrict"
        return
    fi

    if [ "$IN_POLICY" = "deny" ] &&
        [ "$OUT_POLICY" = "deny" ] &&
        [ "$HAS_HTTP_HTTPS" = "yes" ] &&
        [ "$HAS_DNS" = "yes" ]; then
        echo "MODE: open-outbound"
        return
    fi

    if [ "$IPV6" = "yes" ] &&
        [ "$ICMP_INPUT_ENABLED" = "yes" ] &&
        [ "$IN_POLICY" != "deny" ]; then
        echo "MODE: reset"
        return
    fi

    echo "MODE: custom/unknown"
}
