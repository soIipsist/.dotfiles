ufw_open_outbound() {
    # opens outbound connections (good for VM downloads)
    sudo ufw --force reset
    sudo ufw default deny incoming
    sudo ufw default deny outgoing

    if [ -n "$1" ]; then
        HOST_GATEWAY="$1"
    else
        HOST_GATEWAY=$(ip route | awk '/default/ {print $3}')
    fi

    echo "Detected host NAT gateway: $HOST_GATEWAY"

    # Allow only established/related traffic
    sudo ufw allow out from any to any state RELATED,ESTABLISHED
    sudo ufw allow in from any to any state RELATED,ESTABLISHED

    # Outbound to NAT gateway only
    sudo ufw allow out to "$HOST_GATEWAY" proto tcp comment "gateway for NAT"
    sudo ufw allow out to "$HOST_GATEWAY" proto udp comment "gateway for NAT"

    # allow ssh from host to VM
    sudo ufw allow in from "$HOST_GATEWAY" to any port 22 proto tcp

    # DNS
    sudo ufw allow out 53 proto udp

    # HTTP / HTTPS
    sudo ufw allow out 80/tcp
    sudo ufw allow out 443/tcp

    # transmission protocol
    sudo ufw allow out 51413/tcp
    sudo ufw allow out 51413/udp

    sudo ufw --force enable
    sudo ufw reload
    sudo ufw status verbose
}

ufw_restrict() {
    if [ -n "$1" ]; then
        HOST_GATEWAY="$1"
    else
        HOST_GATEWAY=$(ip route | awk '/default/ {print $3}')
    fi

    echo "Detected host gateway: ${HOST_GATEWAY:-<none>}"

    sudo ufw --force reset
    sudo ufw default deny incoming
    sudo ufw default deny outgoing

    # allow SSH
    sudo ufw allow in from "$HOST_GATEWAY" to any port 22 proto tcp

    # block ICMP (no ping)
    sudo ufw deny out proto icmp to any
    sudo ufw deny in proto icmp from any

    sudo ufw --force enable
    sudo ufw reload
    sudo ufw status verbose
}
