ufw_open_outbound() {
    # opens outbound connections (good for VM downloads)
    sudo ufw --force reset
    sudo ufw default deny incoming
    sudo ufw default deny outgoing

    if [ -n "$1" ]; then
        HOST_GATEWAY="$1"
    else
        HOST_GATEWAY=$(ip route | awk '/default/ {print $3}')
    fi

    echo "Detected host NAT gateway: $HOST_GATEWAY"

    # Allow only established/related traffic
    sudo ufw allow out from any to any state RELATED,ESTABLISHED
    sudo ufw allow in from any to any state RELATED,ESTABLISHED

    # Outbound to NAT gateway only
    sudo ufw allow out to "$HOST_GATEWAY" proto tcp comment "gateway for NAT"
    sudo ufw allow out to "$HOST_GATEWAY" proto udp comment "gateway for NAT"

    # allow ssh from host to VM
    sudo ufw allow in from "$HOST_GATEWAY" to any port 22 proto tcp

    # DNS
    sudo ufw allow out 53 proto udp

    # HTTP / HTTPS
    sudo ufw allow out 80/tcp
    sudo ufw allow out 443/tcp

    # transmission protocol
    sudo ufw allow out 51413/tcp
    sudo ufw allow out 51413/udp

    sudo ufw --force enable
    sudo ufw reload
    sudo ufw status verbose
}

ufw_restrict() {
    if [ -n "$1" ]; then
        HOST_GATEWAY="$1"
    else
        HOST_GATEWAY=$(ip route | awk '/default/ {print $3}')
    fi

    echo "Detected host gateway: ${HOST_GATEWAY:-<none>}"

    sudo ufw --force reset
    sudo ufw default deny incoming
    sudo ufw default deny outgoing

    # allow SSH
    sudo ufw allow in from "$HOST_GATEWAY" to any port 22 proto tcp

    # disable IPV6
    sudo sed -i 's/IPV6=yes/IPV6=no/' /etc/default/ufw

    # disable ICMP
    sudo sed -i -E 's/^\s*-A\ ufw-before-input\ -p\ icmp\ --icmp-type.*ACCEPT\s*/#\ \0/g' /etc/ufw/before.rules
    sudo sed -i -E 's/^\s*-A\ ufw-before-forward\ -p\ icmp\ --icmp-type.*ACCEPT\s*/#\ \0/g' /etc/ufw/before.rules

    sudo ufw --force enable
    sudo ufw reload
    sudo ufw status verbose
}

ufw_reset_all() {
    sudo ufw --force reset

    # enable IPV6
    sudo sed -i 's/IPV6=no/IPV6=yes/' /etc/default/ufw

    # enable ICMP
    sudo sed -i -E 's/^#\s*(-A ufw-before-input -p icmp --icmp-type.*ACCEPT)/\1/' /etc/ufw/before.rules
    sudo sed -i -E 's/^#\s*(-A ufw-before-forward -p icmp --icmp-type.*ACCEPT)/\1/' /etc/ufw/before.rules

    sudo ufw reload
    sudo ufw status verbose
}

ufw_status() {
    echo "=== Detecting UFW Mode ==="

    IN_POLICY=$(sudo ufw status | awk '/Default:/ {print $4}')
    OUT_POLICY=$(sudo ufw status | awk '/Default:/ {print $6}')
    IPV6=$(grep "^IPV6=" /etc/default/ufw | cut -d= -f2)
    ICMP_INPUT_ENABLED=$(sudo grep -E '^#\s*-A ufw-before-input -p icmp' /etc/ufw/before.rules >/dev/null && echo no || echo yes)
    ICMP_FORWARD_ENABLED=$(sudo grep -E '^#\s*-A ufw-before-forward -p icmp' /etc/ufw/before.rules >/dev/null && echo no || echo yes)
    HOST_GATEWAY=$(ip route | awk '/default/ {print $3}')
    HAS_SSH_FROM_GATEWAY=$(sudo ufw status numbered | grep -E "ALLOW IN.*22.*$HOST_GATEWAY" >/dev/null && echo yes || echo no)
    HAS_ESTABLISHED=$(sudo ufw status | grep -E "RELATED,ESTABLISHED" >/dev/null && echo yes || echo no)
    HAS_HTTP_HTTPS=$(sudo ufw status | grep -E "80/tcp|443/tcp" >/dev/null && echo yes || echo no)
    HAS_DNS=$(sudo ufw status | grep -E "53.*ALLOW OUT" >/dev/null && echo yes || echo no)

    echo "Inbound policy:   $IN_POLICY"
    echo "Outbound policy:  $OUT_POLICY"
    echo "IPv6 enabled:     $IPV6"
    echo "ICMP enabled:    input=$ICMP_INPUT_ENABLED forward=$ICMP_FORWARD_ENABLED"
    echo "SSH from gateway: $HAS_SSH_FROM_GATEWAY"
    echo "Has ESTABLISHED:  $HAS_ESTABLISHED"
    echo "HTTP/HTTPS:       $HAS_HTTP_HTTPS"
    echo "DNS allowed:      $HAS_DNS"

    echo
    echo "=== Determining Mode ==="

    if [ "$IN_POLICY" = "deny" ] &&
        [ "$OUT_POLICY" = "deny" ] &&
        [ "$HAS_SSH_FROM_GATEWAY" = "yes" ] &&
        [ "$HAS_ESTABLISHED" = "no" ] &&
        [ "$ICMP_INPUT_ENABLED" = "no" ] &&
        [ "$IPV6" = "no" ]; then
        echo "MODE: restrict"
        return
    fi

    if [ "$IN_POLICY" = "deny" ] &&
        [ "$OUT_POLICY" = "deny" ] &&
        [ "$HAS_ESTABLISHED" = "yes" ] &&
        [ "$HAS_HTTP_HTTPS" = "yes" ] &&
        [ "$HAS_DNS" = "yes" ]; then
        echo "MODE: open-outbound"
        return
    fi

    if [ "$IPV6" = "yes" ] &&
        [ "$ICMP_INPUT_ENABLED" = "yes" ] &&
        [ "$IN_POLICY" != "deny" ]; then
        echo "MODE: reset"
        return
    fi

    echo "MODE: custom/unknown"
}
